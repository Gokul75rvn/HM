// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS - Converted to String type for SQLite compatibility
// ============================================================================

// ============================================================================
// CORE ENTITIES
// ============================================================================

model User {
  id                String              @id @default(cuid())
  registrationId    String              @unique
  hospitalId        String
  password          String
  email             String?             @unique
  phone             String?             @unique
  firstName         String
  lastName          String
  role              String              @default("PATIENT")
  status            String              @default("ACTIVE")
  lastLogin         DateTime?
  lastLoginIp       String?
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  deletedAt         DateTime?

  // Relations
  permissions       Permission[]
  auditLogs         AuditLog[]
  notifications     Notification[]
  tokens            RefreshToken[]

  // Specific user types
  doctor            Doctor?
  patient           Patient?
  staff             Staff?
  nurse             Nurse?
  receptionist      Receptionist?
  labTech           LabTech?
  pharmacist        Pharmacist?
  accountant        Accountant?

  @@index([registrationId])
  @@index([hospitalId])
  @@index([role])
  @@index([status])
}

model RoleDefinition {
  id            String        @id @default(cuid())
  name          String        @unique
  description   String?
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  permissions   Permission[]

  @@index([name])
}

model Permission {
  id            String        @id @default(cuid())
  name          String        @unique
  description   String?
  resource      String
  action        String
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  roleId        String?
  role          RoleDefinition? @relation(fields: [roleId], references: [id], onDelete: SetNull)
  
  userId        String?
  user          User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([resource])
  @@index([action])
  @@index([roleId])
  @@index([userId])
}

model RefreshToken {
  id            String        @id @default(cuid())
  token         String        @unique
  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt     DateTime
  revokedAt     DateTime?
  
  createdAt     DateTime      @default(now())

  @@index([userId])
  @@index([expiresAt])
}

// ============================================================================
// DEPARTMENT & STAFF
// ============================================================================

model Department {
  id            String        @id @default(cuid())
  name          String        @unique
  code          String        @unique
  description   String?
  headId        String?
  head          Doctor?       @relation("DepartmentHead", fields: [headId], references: [id], onDelete: SetNull)
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  deletedAt     DateTime?
  
  doctors       Doctor[]
  appointments  Appointment[]
  wards         Ward[]
  admissions    Admission[]

  @@index([headId])
}

model Doctor {
  id                String        @id @default(cuid())
  userId            String        @unique
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  registrationNumber String       @unique
  specialization    String
  qualification     String
  licenseNumber     String?       @unique
  
  departmentId      String?
  department        Department?   @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  
  isAvailable       Boolean       @default(true)
  consultationFee   Int           @default(500)
  experienceYears   Int           @default(0)
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  deletedAt         DateTime?
  
  appointments      Appointment[]
  prescriptions     Prescription[]
  departmentHead    Department[]  @relation("DepartmentHead")
  admissions        Admission[]
  labOrders         LabOrder[]

  @@index([departmentId])
  @@index([specialization])
}

model Staff {
  id            String        @id @default(cuid())
  userId        String        @unique
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  designation   String
  departmentId  String?
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  deletedAt     DateTime?

  @@index([designation])
}

model Nurse {
  id            String        @id @default(cuid())
  userId        String        @unique
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  licenseNumber String?       @unique
  specialization String?
  wardId        String?
  ward          Ward?         @relation(fields: [wardId], references: [id], onDelete: SetNull)
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  deletedAt     DateTime?

  @@index([wardId])
}

model Receptionist {
  id            String        @id @default(cuid())
  userId        String        @unique
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  departmentId  String?
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  deletedAt     DateTime?
}

model LabTech {
  id            String        @id @default(cuid())
  userId        String        @unique
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  certifications String?
  specializations String?
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  deletedAt     DateTime?
}

model Pharmacist {
  id            String        @id @default(cuid())
  userId        String        @unique
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  licenseNumber String?       @unique
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  deletedAt     DateTime?
}

model Accountant {
  id            String        @id @default(cuid())
  userId        String        @unique
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  departmentId  String?
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  deletedAt     DateTime?
}

// ============================================================================
// PATIENT & MEDICAL INFO
// ============================================================================

model Patient {
  id                String        @id @default(cuid())
  userId            String        @unique
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  dateOfBirth       DateTime
  gender            String
  bloodGroup        String?
  maritalStatus     String?
  emergencyContact  String
  emergencyPhone    String
  
  address           String
  city              String
  state             String
  pinCode           String
  country           String        @default("India")
  
  occupation        String?
  allergies         String?
  medicalHistory    String?
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  deletedAt         DateTime?
  
  appointments      Appointment[]
  admissions        Admission[]
  prescriptions     Prescription[]
  labOrders         LabOrder[]
  labResults        LabResult[]
  bills             Bill[]
  payments          Payment[]
  insuranceClaims   InsuranceClaim[]

  @@index([dateOfBirth])
  @@index([bloodGroup])
}

// ============================================================================
// APPOINTMENTS (OPD)
// ============================================================================

model Appointment {
  id                String        @id @default(cuid())
  appointmentNumber String        @unique
  
  patientId         String
  patient           Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  doctorId          String
  doctor            Doctor        @relation(fields: [doctorId], references: [id], onDelete: Restrict)
  
  departmentId      String
  department        Department    @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  
  appointmentDate   DateTime
  appointmentTime   String
  status            String @default("SCHEDULED")
  type              String @default("OPD")
  
  reason            String?
  notes             String?
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  deletedAt         DateTime?
  
  consultationNotes String?
  diagnosisCode     String?

  @@index([patientId])
  @@index([doctorId])
  @@index([departmentId])
  @@index([appointmentDate])
  @@index([status])
}

// ============================================================================
// ADMISSION (IPD) & BEDS
// ============================================================================

model Ward {
  id                String        @id @default(cuid())
  name              String        @unique
  type              String
  departmentId      String
  department        Department    @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  
  totalBeds         Int           @default(20)
  occupiedBeds      Int           @default(0)
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  deletedAt         DateTime?
  
  beds              Bed[]
  nurses            Nurse[]

  @@index([departmentId])
}

model Bed {
  id                String        @id @default(cuid())
  bedNumber         String        @unique
  wardId            String
  ward              Ward          @relation(fields: [wardId], references: [id], onDelete: Cascade)
  
  status            String     @default("AVAILABLE")
  bedType           String
  charges           Int           @default(5000)
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  deletedAt         DateTime?
  
  admissions        Admission[]

  @@index([wardId])
  @@index([status])
}

model Admission {
  id                String        @id @default(cuid())
  admissionNumber   String        @unique
  
  patientId         String
  patient           Patient       @relation(fields: [patientId], references: [id], onDelete: Restrict)
  
  departmentId      String
  department        Department    @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  
  doctorId          String
  doctor            Doctor        @relation(fields: [doctorId], references: [id], onDelete: Restrict)
  
  bedId             String?
  bed               Bed?          @relation(fields: [bedId], references: [id], onDelete: SetNull)
  
  admissionDate     DateTime      @default(now())
  dischargeDate     DateTime?
  status            String @default("ADMITTED")
  
  reason            String
  diagnosis         String?
  treatment         String?
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  deletedAt         DateTime?

  @@index([patientId])
  @@index([departmentId])
  @@index([doctorId])
  @@index([bedId])
  @@index([status])
}

// ============================================================================
// PRESCRIPTIONS & MEDICINES
// ============================================================================

model Prescription {
  id                String        @id @default(cuid())
  prescriptionNumber String       @unique
  
  patientId         String
  patient           Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  doctorId          String
  doctor            Doctor        @relation(fields: [doctorId], references: [id], onDelete: Restrict)
  
  appointmentId     String?
  admissionId       String?
  
  status            String @default("PENDING")
  issuedDate        DateTime      @default(now())
  validUntil        DateTime
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  deletedAt         DateTime?
  
  medicines         PrescriptionItem[]
  bills             Bill[]

  @@index([patientId])
  @@index([doctorId])
  @@index([status])
}

model Medicine {
  id                String        @id @default(cuid())
  name              String        @unique
  genericName       String
  composition       String
  manufacturer      String
  batchNumber       String
  expiryDate        DateTime
  
  unit              String
  price             Int
  
  stock             Int           @default(0)
  reorderLevel      Int           @default(50)
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  deletedAt         DateTime?
  
  prescriptionItems PrescriptionItem[]

  @@index([name])
  @@index([genericName])
  @@index([expiryDate])
}

model PrescriptionItem {
  id                String        @id @default(cuid())
  prescriptionId    String
  prescription      Prescription  @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  
  medicineId        String
  medicine          Medicine      @relation(fields: [medicineId], references: [id], onDelete: Restrict)
  
  dosage            String
  frequency         String
  duration          String
  instructions      String?
  quantity          Int
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([prescriptionId])
  @@index([medicineId])
}

// ============================================================================
// LAB
// ============================================================================

model LabTest {
  id                String        @id @default(cuid())
  testCode          String        @unique
  name              String
  description       String?
  cost              Int           @default(500)
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  deletedAt         DateTime?
  
  orders            LabOrder[]
  results           LabResult[]

  @@index([name])
}

model LabOrder {
  id                String        @id @default(cuid())
  orderNumber       String        @unique
  
  patientId         String
  patient           Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  testId            String
  test              LabTest       @relation(fields: [testId], references: [id], onDelete: Restrict)
  
  doctorId          String
  doctor            Doctor        @relation(fields: [doctorId], references: [id], onDelete: Restrict)
  
  status            String @default("ORDERED")
  orderDate         DateTime      @default(now())
  sampleCollectionDate DateTime?
  
  sampleType        String?
  notes             String?
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  deletedAt         DateTime?
  
  result            LabResult?

  @@index([patientId])
  @@index([testId])
  @@index([doctorId])
  @@index([status])
}

model LabResult {
  id                String        @id @default(cuid())
  orderId           String        @unique
  order             LabOrder      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  patientId         String
  patient           Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  testId            String
  test              LabTest       @relation(fields: [testId], references: [id], onDelete: Restrict)
  
  value             String
  normalRange       String?
  unit              String?
  isAbnormal        Boolean       @default(false)
  remarks           String?
  
  uploadedAt        DateTime      @default(now())
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([patientId])
  @@index([testId])
}

// ============================================================================
// BILLING & PAYMENTS
// ============================================================================

model Bill {
  id                String        @id @default(cuid())
  billNumber        String        @unique
  billType          String      @default("OPD")
  
  patientId         String
  patient           Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  appointmentId     String?
  admissionId       String?
  prescriptionId    String?
  prescription      Prescription? @relation(fields: [prescriptionId], references: [id], onDelete: SetNull)
  
  billDate          DateTime      @default(now())
  dueDate           DateTime
  status            String    @default("DRAFT")
  
  subtotal          Int           @default(0)
  tax               Int           @default(0)
  discount          Int           @default(0)
  totalAmount       Int           @default(0)
  paidAmount        Int           @default(0)
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  deletedAt         DateTime?
  
  items             BillItem[]
  payments          Payment[]
  insuranceClaims   InsuranceClaim[]

  @@index([patientId])
  @@index([billDate])
  @@index([status])
}

model BillItem {
  id                String        @id @default(cuid())
  billId            String
  bill              Bill          @relation(fields: [billId], references: [id], onDelete: Cascade)
  
  description       String
  quantity          Int           @default(1)
  unitPrice         Int
  totalPrice        Int
  
  @@index([billId])
}

model Payment {
  id                String        @id @default(cuid())
  paymentNumber     String        @unique
  
  billId            String
  bill              Bill          @relation(fields: [billId], references: [id], onDelete: Restrict)
  
  patientId         String
  patient           Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  amount            Int
  method            String @default("CASH")
  status            String @default("PENDING")
  
  transactionId     String?       @unique
  reference         String?
  
  paymentDate       DateTime      @default(now())
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([billId])
  @@index([patientId])
  @@index([status])
}

// ============================================================================
// INSURANCE
// ============================================================================

model Insurance {
  id                String        @id @default(cuid())
  providerName      String
  policyNumber      String        @unique
  
  patientId         String?
  
  memberName        String
  relationWithMember String
  
  coverageType      String
  sumInsured        Int
  
  validFrom         DateTime
  validUpto         DateTime
  status            String @default("ACTIVE")
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  deletedAt         DateTime?
  
  claims            InsuranceClaim[]

  @@index([policyNumber])
  @@index([status])
}

model InsuranceClaim {
  id                String        @id @default(cuid())
  claimNumber       String        @unique
  
  patientId         String
  patient           Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  billId            String
  bill              Bill          @relation(fields: [billId], references: [id], onDelete: Cascade)
  
  insuranceId       String
  insurance         Insurance     @relation(fields: [insuranceId], references: [id], onDelete: Restrict)
  
  claimAmount       Int
  approvedAmount    Int           @default(0)
  status            String @default("SUBMITTED")
  
  submittedDate     DateTime      @default(now())
  processedDate     DateTime?
  remarks           String?
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([patientId])
  @@index([billId])
  @@index([insuranceId])
  @@index([status])
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

model Notification {
  id                String        @id @default(cuid())
  userId            String
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type              String
  title             String
  message           String
  
  isRead            Boolean       @default(false)
  relatedId         String?
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([userId])
  @@index([createdAt])
  @@index([isRead])
}

// ============================================================================
// AUDIT LOG
// ============================================================================

model AuditLog {
  id                String        @id @default(cuid())
  
  userId            String
  user              User          @relation(fields: [userId], references: [id], onDelete: Restrict)
  
  action            String
  resource          String
  resourceId        String
  
  oldValues         String?
  newValues         String?
  
  ipAddress         String?
  userAgent         String?
  
  createdAt         DateTime      @default(now())

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
}
